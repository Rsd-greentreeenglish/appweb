<!doctype html>
<html lang="fa" dir="rtl">
<head>
Â  Â  <meta charset="utf-8" />
Â  Â  <meta name="viewport" content="width=device-width,initial-scale=1" />
Â  Â  <title>Ù¾ÙˆØ±ØªØ§Ù„ Ø²Ø¨Ø§Ù†â€ŒØ¢Ù…ÙˆØ²</title>
Â  Â  
Â  Â  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
Â  Â  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
Â  Â  
Â  Â  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />

<style>
/* ----------------------------
  Reset & Base
---------------------------- */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Vazirmatn', sans-serif;
}

body {
  background: #f2f2f5;
  color: #222;
  line-height: 1.5;
  padding: 16px;
}

h1, h2, h3, h4 {
  margin-bottom: 12px;
  color: #333;
}

h1 { font-size: 2rem; }
h3 { font-size: 1.4rem; }
h4 { font-size: 1.1rem; }

/* ----------------------------
  Wrap & Layout
---------------------------- */
.wrap {
  max-width: 960px;
  margin: 0 auto;
}

/* ----------------------------
  Cards
---------------------------- */
.card {
  background: #fff;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 20px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.card small {
  color: #666;
  font-size: 0.9rem;
}

/* ----------------------------
  Rows & Columns
---------------------------- */
.row {
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
}

.col {
  flex: 1;
  min-width: 180px;
  display: flex;
  flex-direction: column;
}

label {
  margin-bottom: 6px;
  font-weight: 500;
}

input, select, textarea, button {
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 8px 12px;
  font-size: 1rem;
}

input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 2px rgba(0,123,255,0.2);
}

button {
  background: #007bff;
  color: #fff;
  cursor: pointer;
  transition: 0.2s;
  border: none;
}

button:hover {
  background: #0056b3;
}

/* ----------------------------
  Tables
---------------------------- */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 12px;
  margin-bottom: 12px;
}

th, td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: center;
}

th {
  background-color: #007bff;
  color: #fff;
  font-weight: 600;
}

/* ----------------------------
  Announcements
---------------------------- */
#announcement-list .card {
  background: rgba(0,123,255,0.05);
}

/* ----------------------------
  Responsive
---------------------------- */
@media screen and (max-width: 600px) {
  .row {
    flex-direction: column;
  }
  button {
    width: 100%;
  }
}

/* ----------------------------
  Minor Styles
---------------------------- */
hr {
  border: none;
  border-top: 1px solid rgba(0,0,0,0.1);
  margin: 16px 0;
}

.small {
  font-size: 0.9rem;
}

</style>



</head>
<body>
Â  Â  
Â  Â  <div class="wrap">
Â  Â  Â  Â  <h1>Ù¾ÙˆØ±ØªØ§Ù„ Ø²Ø¨Ø§Ù†â€ŒØ¢Ù…ÙˆØ²</h1>
Â  Â  Â  Â  <div class="small" style="margin-bottom: 20px;">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§ Ø§Ø² Ø³Ø±ÙˆØ± Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>

Â  Â  Â  Â  <div id="announcements" class="card">
Â  Â  Â  Â  Â  Â  <h4>ğŸ“¢ Ø§Ø·Ù„Ø§Ø¹ÛŒÙ‡â€ŒÙ‡Ø§ Ùˆ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ (Ûµ Ù¾ÛŒØ§Ù… Ø¢Ø®Ø±)</h4>
Â  Â  Â  Â  Â  Â  <div id="announcement-list">... Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ ...</div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <section id="student-view" class="card">
Â  Â  Â  Â  Â  Â  <h3>Ø¬Ø³ØªØ¬Ùˆ Ùˆ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ø¨Ø§ Ú©Ø¯ Ù…Ù„ÛŒ</h3>
Â  Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="col">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Ú©Ø¯ Ù…Ù„ÛŒ</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="sv-nid" placeholder="Ú©Ø¯ Ù…Ù„ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" />
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="width:140px">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="sv-show">Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div style="margin-top:16px" id="sv-result">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="small">Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ù…Ù„ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù‡ Ùˆ Ø¯Ú©Ù…Ù‡ "Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª" Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯ ØªØ§ Ø³ÙˆØ§Ø¨Ù‚ Ø´Ù…Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯.</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </section>
Â  Â  Â  Â  
Â  Â  </div>

Â  Â  <script>
Â  Â  Â  Â  // ==========================================
Â  Â  Â  Â  // Ø¬Ø§ÙˆØ§Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø§ØµÙ„ÛŒ (jsapp.js)
Â  Â  Â  Â  // ==========================================

Â  Â  const firebaseConfig = {
Â  Â  Â  apiKey: "AIzaSyD0wD1laV1CE5cD6CJnHsNEBMAggpLFrAw",
Â  Â  Â  authDomain: "app-web-30f0e.firebaseapp.com",
Â  Â  Â  projectId: "app-web-30f0e",
Â  Â  Â  storageBucket: "app-web-30f0e.firebasestorage.app",
Â  Â  Â  messagingSenderId: "122904965586",
Â  Â  Â  appId: "1:122904965586:web:39a3f5c9b4ac815070d80b",
Â  Â  Â  measurementId: "G-HFWT1BBW0F"
Â  Â  };

Â  Â  // Initialize Firebase
Â  Â  const app = firebase.initializeApp(firebaseConfig);
Â  Â  const db = app.firestore();

Â  Â  // Collection/Document structure for simplicity (mimicking localStorage)
Â  Â  const DATA_STORE_COLLECTION = 'data_store';

Â  Â  // Global in-memory cache
Â  Â  let classesCache = [];
Â  Â  let studentsCache = [];
Â  Â  let attendanceCache = {};
Â  Â  let announcementsCache = [];
Â  Â  
Â  Â  // Custom Error Message
Â  Â  const FIREBASE_ERROR_MESSAGE = "Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³. ÙÛŒÙ„ØªØ±Ø´Ú©Ù† Ø®ÙˆØ¯ Ø±Ø§ Ø±ÙˆØ´Ù† Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø§Ú¯Ø± Ø±ÙˆØ´Ù† Ù‡Ø³Øª Ø¨Ù‡ Ù…Ú©Ø§Ù†ÛŒ Ø¯ÛŒÚ¯Ø± ÙˆØµÙ„ Ø´ÙˆÛŒØ¯.";

Â  Â  /**
Â  Â  Â * Wraps an async Firebase operation with custom error handling.
Â  Â  Â * @param {function} operation - The async function containing the Firebase call.
Â  Â  Â * @returns {Promise<any>} The result of the operation.
Â  Â  Â */
Â  Â  async function handleFirebaseOperation(operation) {
Â  Â  Â  try {
Â  Â  Â  Â  return await operation();
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error("Firebase Error:", error);
Â  Â  Â  Â  alert(FIREBASE_ERROR_MESSAGE + "\n\nØ¬Ø²Ø¦ÛŒØ§Øª Ø®Ø·Ø§: " + error.message.substring(0, 100) + '...'); // Truncate error message
Â  Â  Â  Â  throw new Error('Firebase operation failed due to connection error.');
Â  Â  Â  }
Â  Â  }

Â  Â  // Asynchronous Fetch Data from Firestore
Â  Â  async function fetchData(docId, defaultValue) {
Â  Â  Â  return await handleFirebaseOperation(async () => {
Â  Â  Â  Â  const docRef = db.collection(DATA_STORE_COLLECTION).doc(docId);
Â  Â  Â  Â  const doc = await docRef.get();
Â  Â  Â  Â  return doc.exists ? doc.data().data || defaultValue : defaultValue;
Â  Â  Â  });
Â  Â  }

Â  Â  // Asynchronous Save All Data to Firestore (using batch for atomic update)
Â  Â  async function saveAllData() {
Â  Â  Â  await handleFirebaseOperation(async () => {
Â  Â  Â  Â  const batch = db.batch();
Â  Â  Â  Â  
Â  Â  Â  Â  // Prepare batch writes
Â  Â  Â  Â  batch.set(db.collection(DATA_STORE_COLLECTION).doc('classes'), { data: classesCache });
Â  Â  Â  Â  batch.set(db.collection(DATA_STORE_COLLECTION).doc('students'), { data: studentsCache });
Â  Â  Â  Â  batch.set(db.collection(DATA_STORE_COLLECTION).doc('attendance'), { data: attendanceCache });
Â  Â  Â  Â  batch.set(db.collection(DATA_STORE_COLLECTION).doc('announcements'), { data: announcementsCache });
Â  Â  Â  Â  
Â  Â  Â  Â  await batch.commit();
Â  Â  Â  });
Â  Â  }

Â  Â  // Data access functions (now synchronous, reading from cache)
Â  Â  const $ = id=>document.getElementById(id);
Â  Â  let currentRole = 'admin';

Â  Â  function uid(){return 'c'+Date.now()+Math.floor(Math.random()*99)}
Â  Â  function getClasses(){return classesCache;}
Â  Â  function getStudents(){return studentsCache;}
Â  Â  function getAttendance(){return attendanceCache;}
Â  Â  function getAnnouncements(){return announcementsCache;}

Â  Â  // --- STUDENT SELECT POPULATION HELPER ---
Â  Â  function populateStudentSelect(classId, selectId){
Â  Â  Â  const select = $(selectId);
Â  Â  Â  select.innerHTML = '';
Â  Â  Â  if (!classId) return;
Â  Â  Â  const students = getStudents().filter(s => s.classId === classId);
Â  Â  Â  if (students.length === 0) {
Â  Â  Â  Â  const opt = document.createElement('option');
Â  Â  Â  Â  opt.textContent = 'Ú©Ù„Ø§Ø³ÛŒ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª';
Â  Â  Â  Â  opt.value = '';
Â  Â  Â  Â  select.appendChild(opt);
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  students.forEach(s => {
Â  Â  Â  Â  const opt = document.createElement('option');
Â  Â  Â  Â  opt.value = s.nid;
Â  Â  Â  Â  opt.textContent = s.name + ' (' + s.nid + ')';
Â  Â  Â  Â  select.appendChild(opt);
Â  Â  Â  });
Â  Â  }
Â  Â  
Â  Â  window.populateDependentStudentSelect = function(classSelectId, studentSelectId) {
Â  Â  Â  const classId = $(classSelectId).value;
Â  Â  Â  populateStudentSelect(classId, studentSelectId);
Â  Â  }
Â  Â  
Â  Â  // --- ROLE MANAGEMENT (Shallow implementation) ---
Â  Â  function setCurrentRole(role){
Â  Â  Â  currentRole = role;
Â  Â  Â  // Ø§ÛŒÙ† ØªÙˆØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ù†Ù…Ø§ÛŒ ØªÚ©â€ŒØµÙØ­Ù‡â€ŒØ§ÛŒ student-view Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² Ù†ÛŒØ³ØªÙ†Ø¯ Ø§Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø®Ø·Ø§ Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ù†Ø¯.
Â  Â  Â  document.querySelectorAll('.admin-only').forEach(el=>el.style.display = (role === 'admin' ? 'block' : 'none'));
Â  Â  Â  document.querySelectorAll('.admin-teacher-only').forEach(el=>el.style.display = (role === 'admin' || role === 'teacher' ? 'block' : 'none'));

Â  Â  Â  if(role === 'student'){
Â  Â  Â  Â  showSection('student-view', 'btn-student-view');
Â  Â  Â  } else if (role === 'teacher') {
Â  Â  Â  Â  showSection('dashboard', 'btn-dashboard');
Â  Â  Â  } else {
Â  Â  Â  Â  showSection('panel', 'btn-panel');
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  const msgBox = $('dashboard')?.querySelector('.right-panel .card:nth-child(3)');
Â  Â  Â  if(msgBox) msgBox.style.display = (role === 'admin' || role === 'teacher' ? 'block' : 'none');
Â  Â  }

Â  Â  function refreshLists(){
Â  Â  Â  const classes=getClasses();
Â  Â  Â  
Â  Â  Â  // Ø§Ø² Ø¢Ù†Ø¬Ø§ÛŒÛŒ Ú©Ù‡ Ø§ÛŒÙ† Ø¹Ù†Ø§ØµØ± Ø¯Ø± HTML ÙØ¹Ù„ÛŒ Ø­Ø°Ù Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯ØŒ Ø¨Ø±Ø±Ø³ÛŒ null Ù„Ø§Ø²Ù… Ø§Ø³Øª.
Â  Â  Â  const studentClasses = $('student-class');
Â  Â  Â  const dash = $('dashboard-class');
Â  Â  Â  const quick = $('select-class-quick');
Â  Â  Â  const tuitionClass = $('tuition-class');
Â  Â  Â  const bookClassSelect = $('book-class-select');
Â  Â  Â  
Â  Â  Â  // Ø§ÛŒÙ† Ø­Ù„Ù‚Ù‡ Ø¹Ù†Ø§ØµØ± Select Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª (Ù…Ø§Ù†Ù†Ø¯ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¹Ù„Ù… ÛŒØ§ Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ†) Ø±Ø§ Ù¾Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
Â  Â  Â  // Ø§Ø² Ø¢Ù†Ø¬Ø§ÛŒÛŒ Ú©Ù‡ Ø§ÛŒÙ† Ø¹Ù†Ø§ØµØ± Ø¯Ø± HTML ÙØ¹Ù„ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ù†Ø¯ØŒ Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø¨Ø§Ù„Ø§ null Ù‡Ø³ØªÙ†Ø¯ Ùˆ Ø­Ù„Ù‚Ù‡ Ø§Ø¬Ø±Ø§ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯.
Â  Â  Â  [studentClasses,dash,quick,tuitionClass,bookClassSelect].forEach(sel=>{
Â  Â  Â  Â  if(!sel) return;
Â  Â  Â  Â  // Ø§Ú¯Ø± Ø³Ù„Ú©Øªâ€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ù…ÛŒ Ø¯Ø± Ø§Ù†ØªÙ‡Ø§ÛŒ Ú©Ø¯ ØªØ¹Ø±ÛŒÙ Ø´ÙˆÙ†Ø¯ØŒ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø§Ø¬Ø±Ø§ Ø´Ø¯Ù‡ Ùˆ Ù…Ø­ØªÙˆØ§ÛŒ <option> Ø±Ø§
Â  Â  Â  Â  // Ø¨Ù‡ ØµÙˆØ±Øª Ù…ØªÙ† Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯. Ø§Ú¯Ø± Ø¹Ù†Ø§ØµØ± Ø¯Ø§Ù…ÛŒ Ø­Ø°Ù Ø´ÙˆÙ†Ø¯ØŒ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¨Ø¯ÙˆÙ† Ù…Ø´Ú©Ù„ Ø±Ø¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
Â  Â  Â  Â  sel.innerHTML='';
Â  Â  Â  Â  classes.forEach(c=>{
Â  Â  Â  Â  Â  const opt=document.createElement('option');opt.value=c.id;opt.textContent=c.name+' â€” Ù…Ø¹Ù„Ù…: '+c.teacher;sel.appendChild(opt);
Â  Â  Â  Â  })
Â  Â  Â  })
Â  Â  Â  
Â  Â  Â  if (classes.length > 0) {
Â  Â  Â  Â  if ($('tuition-class')) populateStudentSelect(tuitionClass.value, 'tuition-student-select');
Â  Â  Â  Â  if ($('book-class-select')) populateStudentSelect(bookClassSelect.value, 'book-student-select');
Â  Â  Â  Â  
Â  Â  Â  Â  // Set initial value for dashboard class if available
Â  Â  Â  Â  if ($('dashboard')?.style.display === 'block') {
Â  Â  Â  Â  Â  updateDashboardStudents();
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  // Ø§ÛŒÙ† Ø¨Ø®Ø´ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§ Ø¯Ø± Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ† Ø¨ÙˆØ¯ Ùˆ ØºÛŒØ±ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯.
Â  Â  Â  /*
Â  Â  Â  const clDiv=$('classes-list');
Â  Â  Â  if(clDiv) {
Â  Â  Â  Â  clDiv.innerHTML='';
Â  Â  Â  Â  if(classes.length===0){clDiv.textContent='Ù‡Ù†ÙˆØ² Ú©Ù„Ø§Ø³ÛŒ Ø³Ø§Ø®ØªÙ‡ Ù†Ø´Ø¯Ù‡.';return}
Â  Â  Â  Â  classes.forEach(c=>{
Â  Â  Â  Â  Â  const d=document.createElement('div');d.className='small';d.innerHTML=`<strong>${c.name}</strong> â€” Ù…Ø¹Ù„Ù…: ${c.teacher} â€” Ú©ØªØ§Ø¨: ${c.book} â€” ØªØ±Ù…â€ŒÙ‡Ø§: ${c.terms} â€” Ø¬Ù„Ø³Ø§Øª/ØªØ±Ù…: ${c.sessionsPerTerm}`;
Â  Â  Â  Â  Â  clDiv.appendChild(d);
Â  Â  Â  Â  })
Â  Â  Â  }
Â  Â  Â  */
Â  Â  Â  
Â  Â  Â  refreshAnnouncementsList();
Â  Â  }

Â  Â  async function addClass(){
Â  Â  Â  // Ù…Ù†Ø·Ù‚ Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø°Ù Ø´Ø¯
Â  Â  }

Â  Â  async function deleteClass(){
Â  Â  Â  // Ù…Ù†Ø·Ù‚ Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø°Ù Ø´Ø¯
Â  Â  }
Â  Â  
Â  Â  async function addStudent(){
Â  Â  Â  // Ù…Ù†Ø·Ù‚ Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø°Ù Ø´Ø¯
Â  Â  }

Â  Â  async function deleteStudent(){
Â  Â  Â  // Ù…Ù†Ø·Ù‚ Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø°Ù Ø´Ø¯
Â  Â  }

Â  Â  async function saveTuition(){
Â  Â  Â  // Ù…Ù†Ø·Ù‚ Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø°Ù Ø´Ø¯
Â  Â  }

Â  Â  async function saveBook(){
Â  Â  Â  // Ù…Ù†Ø·Ù‚ Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø°Ù Ø´Ø¯
Â  Â  }

Â  Â  async function sendMessage(senderRole){
Â  Â  Â  // Ù…Ù†Ø·Ù‚ Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø°Ù Ø´Ø¯
Â  Â  }
Â  Â  if($('send-message')) $('send-message').addEventListener('click',()=>sendMessage(currentRole));
Â  Â  
Â  Â  async function addAnnouncement(){
Â  Â  Â  // Ù…Ù†Ø·Ù‚ Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø°Ù Ø´Ø¯
Â  Â  }
Â  Â  if($('add-announcement')) $('add-announcement').addEventListener('click', addAnnouncement);

Â  Â  function refreshAnnouncementsList(){
Â  Â  Â  // Reads from announcementsCache, no change needed
Â  Â  Â  const announcements = getAnnouncements();
Â  Â  Â  const listDiv = $('announcement-list');
Â  Â  Â  if(!listDiv) return;
Â  Â  Â  
Â  Â  Â  listDiv.innerHTML = '';
Â  Â  Â  if(announcements.length === 0) {
Â  Â  Â  Â  listDiv.innerHTML = '<div class="small">Ø§Ø·Ù„Ø§Ø¹ÛŒÙ‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>';
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  announcements.slice(0, 5).forEach(announcement => {
Â  Â  Â  Â  const d = document.createElement('div');
Â  Â  Â  Â  d.className = 'card small';
Â  Â  Â  Â  d.style.marginBottom = '6px';
Â  Â  Â  Â  d.innerHTML = `<strong>${announcement.title}</strong><span style="float:left">${announcement.date}</span><p style="margin-top:4px">${announcement.text}</p>`;
Â  Â  Â  Â  listDiv.appendChild(d);
Â  Â  Â  });
Â  Â  Â  if(announcements.length > 5) {
Â  Â  Â  Â  listDiv.innerHTML += '<div class="small" style="text-align:center">... Ø§Ø·Ù„Ø§Ø¹ÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ± Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª.</div>';
Â  Â  Â  }
Â  Â  }
Â  Â  
Â  Â  function updateDashboardStudents(){
Â  Â  Â  // Ù…Ù†Ø·Ù‚ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø­Ø°Ù Ø´Ø¯
Â  Â  }


Â  Â  async function buildAttendanceTable(){
Â  Â  Â  // Ù…Ù†Ø·Ù‚ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø­Ø°Ù Ø´Ø¯
Â  Â  }

Â  Â  function calcAbsences(arr){
Â  Â  Â  if(!arr) return 0;let c=0;arr.forEach(v=>{if(v===false)c++});return c;
Â  Â  }

Â  Â  window.showOnlyStudent = function(nid,classId){
Â  Â  Â  // Ù…Ù†Ø·Ù‚ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø­Ø°Ù Ø´Ø¯
Â  Â  }

Â  Â  function updateStudentStatsPanel(nid,classId){
Â  Â  Â  // Ù…Ù†Ø·Ù‚ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø­Ø°Ù Ø´Ø¯
Â  Â  }

Â  Â  function showStudentFromSearch(){
Â  Â  Â  // Ù…Ù†Ø·Ù‚ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø­Ø°Ù Ø´Ø¯
Â  Â  }

Â  Â  async function saveGrade(){
Â  Â  Â  // Ù…Ù†Ø·Ù‚ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø­Ø°Ù Ø´Ø¯
Â  Â  }

Â  Â  async function studentViewShow(){
Â  Â  Â  // Reads from cache, no change needed (only fetching data is async)
Â  Â  Â  const nid=$('sv-nid').value.trim();
Â  Â  Â  const out=$('sv-result');out.innerHTML='';
Â  Â  Â  if(!nid){out.innerHTML='<div class="small">Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ù…Ù„ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.</div>';return}
Â  Â  Â  
Â  Â  Â  const classes=getClasses();
Â  Â  Â  const students=getStudents();
Â  Â  Â  
Â  Â  Â  const studentEntries = students.filter(s=>s.nid===nid);
Â  Â  Â  
Â  Â  Â  if(studentEntries.length === 0){out.innerHTML='<div class="small">Ø²Ø¨Ø§Ù†â€ŒØ¢Ù…ÙˆØ² Ø¨Ø§ Ø§ÛŒÙ† Ú©Ø¯ Ù…Ù„ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</div>';return}
Â  Â  Â  
Â  Â  Â  const st = studentEntries[0]; 
Â  Â  Â  
Â  Â  Â  out.appendChild(document.createElement('h3')).textContent = 'ÙˆØ¶Ø¹ÛŒØª Ø²Ø¨Ø§Ù†â€ŒØ¢Ù…ÙˆØ²: ' + st.name + ' (' + st.nid + ')';
Â  Â  Â  
Â  Â  Â  studentEntries.forEach(entry => {
Â  Â  Â  Â  const clsId = entry.classId;
Â  Â  Â  Â  const cls = classes.find(c => c.id === clsId);
Â  Â  Â  Â  const attendance=getAttendance();const attEntry=(attendance[clsId]||{})[nid];
Â  Â  Â  Â  
Â  Â  Â  Â  out.appendChild(document.createElement('h4')).textContent = 'Ø³ÙˆØ§Ø¨Ù‚ Ù†Ù…Ø±Ù‡ Ùˆ Ø­Ø¶ÙˆØ± Ø¯Ø± Ú©Ù„Ø§Ø³ ' + (cls?.name || 'Ù†Ø§Ù…Ø¹Ù„ÙˆÙ…');
Â  Â  Â  Â  
Â  Â  Â  Â  if(attEntry && cls){
Â  Â  Â  Â  Â  const totalCols = cls.terms * cls.sessionsPerTerm;
Â  Â  Â  Â  Â  const tbl=document.createElement('table');
Â  Â  Â  Â  Â  const h=document.createElement('tr');h.innerHTML='<th>ØªØ±Ù…</th><th>Ø­Ø¶ÙˆØ±</th><th>ØºÛŒØ¨Øª</th><th>Ø«Ø¨Øª Ø´Ø¯Ù‡</th><th>Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡</th><th>Ù†Ù…Ø±Ù‡</th>';
Â  Â  Â  Â  Â  tbl.appendChild(h);
Â  Â  Â  Â  Â  for(let t=1;t<=cls.terms;t++){
Â  Â  Â  Â  Â  Â  const sIndex=(t-1)*cls.sessionsPerTerm; const slice = attEntry.present.slice(sIndex,sIndex+cls.sessionsPerTerm);
Â  Â  Â  Â  Â  Â  const present = slice.filter(v=>v===true).length; const absent = slice.filter(v=>v===false).length; const marked = slice.filter(v=>v!==null).length; const remaining = slice.filter(v=>v===null).length;
Â  Â  Â  Â  Â  Â  const tr=document.createElement('tr'); tr.innerHTML=`<td>${t}</td><td>${present}</td><td>${absent}</td><td>${marked}</td><td>${remaining}</td><td>${(attEntry.grades && attEntry.grades[t]!==undefined)?attEntry.grades[t]:'-'}</td>`; tbl.appendChild(tr);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  out.appendChild(tbl);
Â  Â  Â  Â  Â  const totalAbs = attEntry.present.filter(v=>v===false).length;const totalMarked=attEntry.present.filter(v=>v!==null).length;
Â  Â  Â  Â  Â  const div=document.createElement('div');div.className='small';div.style.marginTop='8px';div.innerHTML=`<div><strong>Ú©Ù„ ØºÛŒØ¨Øªâ€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ† Ú©Ù„Ø§Ø³:</strong> ${totalAbs}</div><div><strong>Ø¬Ù„Ø³Ø§Øª Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡ Ø§ÛŒÙ† Ú©Ù„Ø§Ø³:</strong> ${totalMarked}/${totalCols}</div>`;
Â  Â  Â  Â  Â  out.appendChild(div);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  out.innerHTML+='<div class="small">Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø²Ø¨Ø§Ù†â€ŒØ¢Ù…ÙˆØ² Ø¯Ø± Ø§ÛŒÙ† Ú©Ù„Ø§Ø³ Ø¬Ø¯ÙˆÙ„ Ø­Ø¶ÙˆØ±/Ù†Ù…Ø±Ù‡ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>';
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  Â  
Â  Â  Â  out.appendChild(document.createElement('hr')).style.cssText = 'border:none;border-top:1px solid rgba(0,0,0,0.1);margin:16px 0';

Â  Â  Â  out.appendChild(document.createElement('h4')).textContent = 'Ø³Ø§Ø¨Ù‚Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ù‡Ø±ÛŒÙ‡ (ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú©Ù„)';
Â  Â  Â  if(st.tuition && st.tuition.length > 0) {
Â  Â  Â  Â  const tTbl=document.createElement('table');
Â  Â  Â  Â  const tH=document.createElement('tr');tH.innerHTML='<th>ØªØ§Ø±ÛŒØ®</th><th>Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)</th><th>Ú©Ù„Ø§Ø³ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡</th>';tTbl.appendChild(tH);
Â  Â  Â  Â  st.tuition.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(t => {
Â  Â  Â  Â  Â  const tr=document.createElement('tr');tr.innerHTML=`<td>${t.date}</td><td>${t.amount.toLocaleString('fa-IR')}</td><td>${classes.find(c => c.id === t.classId)?.name || '-'}</td>`;tTbl.appendChild(tr);
Â  Â  Â  Â  });
Â  Â  Â  Â  out.appendChild(tTbl);
Â  Â  Â  } else {
Â  Â  Â  Â  out.innerHTML+='<div class="small">Ø³Ø§Ø¨Ù‚Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ù‡Ø±ÛŒÙ‡ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>';
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  out.appendChild(document.createElement('h4')).textContent = 'Ú©ØªØ§Ø¨â€ŒÙ‡Ø§ÛŒ Ú¯Ø°Ø±Ø§Ù†Ø¯Ù‡ Ø´Ø¯Ù‡ (ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú©Ù„)';
Â  Â  Â  if(st.books && st.books.length > 0) {
Â  Â  Â  Â  const bTbl=document.createElement('table');
Â  Â  Â  Â  const bH=document.createElement('tr');bH.innerHTML='<th>Ù†Ø§Ù… Ú©ØªØ§Ø¨</th><th>ØªØ§Ø±ÛŒØ® Ø§ØªÙ…Ø§Ù…</th>';bTbl.appendChild(bH);
Â  Â  Â  Â  st.books.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(b => {
Â  Â  Â  Â  Â  const tr=document.createElement('tr');tr.innerHTML=`<td>${b.name}</td><td>${b.date}</td>`;bTbl.appendChild(tr);
Â  Â  Â  Â  });
Â  Â  Â  Â  out.appendChild(bTbl);
Â  Â  Â  } else {
Â  Â  Â  Â  out.innerHTML+='<div class="small">Ø³Ø§Ø¨Ù‚Ù‡ Ú©ØªØ§Ø¨ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>';
Â  Â  Â  }

Â  Â  Â  out.appendChild(document.createElement('h4')).textContent = 'ØµÙ†Ø¯ÙˆÙ‚ Ù¾ÛŒØ§Ù… (ØªØ°Ú©Ø±Ø§Øª)';
Â  Â  Â  if(st.messages && st.messages.length > 0) {
Â  Â  Â  Â  st.messages.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(m => {
Â  Â  Â  Â  Â  const d = document.createElement('div');
Â  Â  Â  Â  Â  d.className = 'card small';
Â  Â  Â  Â  Â  d.style.background = 'rgba(0,123,255,0.05)'; 
Â  Â  Â  Â  Â  d.style.marginBottom = '6px';
Â  Â  Â  Â  Â  d.innerHTML = `<strong>${m.sender === 'admin' ? 'Ù…Ø¯ÛŒØ±' : 'Ù…Ø¹Ù„Ù…'}</strong> <span style="float:left">${m.date}</span><p style="margin-top:4px">${m.text}</p>`;
Â  Â  Â  Â  Â  out.appendChild(d);
Â  Â  Â  Â  });
Â  Â  Â  } else {
Â  Â  Â  Â  out.innerHTML+='<div class="small">ØµÙ†Ø¯ÙˆÙ‚ Ù¾ÛŒØ§Ù… Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.</div>';
Â  Â  Â  }
Â  Â  }

Â  Â  // UI navigation
Â  Â  if($('btn-panel')) $('btn-panel').addEventListener('click',()=>{showSection('panel','btn-panel')});
Â  Â  if($('btn-dashboard')) $('btn-dashboard').addEventListener('click',async ()=>{showSection('dashboard','btn-dashboard');await buildAttendanceTable();});
Â  Â  if($('btn-student-view')) $('btn-student-view').addEventListener('click',()=>{showSection('student-view','btn-student-view');refreshLists();});

Â  Â  function showSection(id,btnId){
Â  Â  Â  // Ø§ÛŒÙ† ØªÙˆØ§Ø¨Ø¹ Ù†ÛŒØ² Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒ ØªÚ©â€ŒØµÙØ­Ù‡â€ŒØ§ÛŒ Ø³Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯ ØªØ§ ÙÙ‚Ø· Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ù‡Ù†Ø¯
Â  Â  Â  ['panel','dashboard','student-view','announcements'].forEach(s=>{if($(s)) $(s).style.display = 'none'});
Â  Â  Â  const targetSection = $(id);
Â  Â  Â  if(targetSection) targetSection.style.display = 'block';

Â  Â  Â  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
Â  Â  Â  if(btnId && $(btnId)) $(btnId).classList.add('active');
Â  Â  Â  refreshLists();
Â  Â  Â  if (id === 'dashboard') { updateDashboardStudents(); }
Â  Â  }
Â  Â  
Â  Â  // Admin Only features access check (before event listeners)
Â  Â  // Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø°Ù Ø´Ø¯
Â  Â  // Ø³Ø§ÛŒØ± Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ Ú©Ù‡ Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ Ø¹Ù†Ø§ØµØ± Ø­Ø°Ù Ø´Ø¯Ù‡ Ù‡Ø³ØªÙ†Ø¯ØŒ Ø­Ø°Ù Ø´Ø¯Ù†Ø¯ ÛŒØ§ Ø¨Ø§ null check Ù…Ø­Ø§ÙØ¸Øª Ø´Ø¯Ù†Ø¯
Â  Â  
Â  Â  if ($('sv-show')) $('sv-show').addEventListener('click',studentViewShow);

Â  Â  // ==========================================
Â  Â  // INITIAL LOAD FUNCTION
Â  Â  // ==========================================
Â  Â  async function initialLoad() {
Â  Â  Â  try {
Â  Â  Â  Â  // Fetch all data and populate cache (using default values for empty data)
Â  Â  Â  Â  const [classes, students, attendance, announcements] = await Promise.all([
Â  Â  Â  Â  Â  fetchData('classes', []),
Â  Â  Â  Â  Â  fetchData('students', []),
Â  Â  Â  Â  Â  fetchData('attendance', {}),
Â  Â  Â  Â  Â  fetchData('announcements', [])
Â  Â  Â  Â  ]);

Â  Â  Â  Â  classesCache = classes;
Â  Â  Â  Â  studentsCache = students;
Â  Â  Â  Â  attendanceCache = attendance;
Â  Â  Â  Â  announcementsCache = announcements;
Â  Â  Â  Â  
Â  Â  Â  Â  // Now that data is in cache, initialize UI
Â  Â  Â  Â  refreshLists();
Â  Â  Â  Â  setCurrentRole('student'); // ØªÙ†Ø¸ÛŒÙ… Ù†Ù‚Ø´ Ø¨Ù‡ student Ø¨Ø±Ø§ÛŒ Ù¾ÙˆØ±ØªØ§Ù„ Ø²Ø¨Ø§Ù†â€ŒØ¢Ù…ÙˆØ²
Â  Â  Â  Â  
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  // Error already alerted by handleFirebaseOperation, just log and halt UI init
Â  Â  Â  Â  console.log('UI initialization halted due to Firebase error.');
Â  Â  Â  }
Â  Â  }

Â  Â  // Run initial load
Â  Â  initialLoad();
Â  Â  
Â  Â  
Â  Â  // Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ù†Ù…Ø§ÛŒØ´ ØµØ­ÛŒØ­ student-view Ø¯Ø± Ø§Ø¨ØªØ¯Ø§ (Ù¾Ø³ Ø§Ø² Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡)
Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  showSection('student-view', 'btn-student-view'); 
Â  Â  });
Â  Â  
Â  Â  
Â  Â  // Ø¹Ù†Ø§ØµØ± Ø¯Ø§Ù…ÛŒ Ú©Ù‡ Ø¨Ø§Ø¹Ø« Ù…Ø´Ú©Ù„ Ù…ÛŒâ€ŒØ´Ø¯Ù†Ø¯ Ø­Ø°Ù Ø´Ø¯Ù†Ø¯.
Â  Â  
Â  Â  </script>
</body>
</html>
